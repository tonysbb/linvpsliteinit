# VPS Init Script Audit - Validation Checklist

This checklist can be used to verify fixes for the audit findings.

## Critical Issues (Must Fix Before Production)

### CRITICAL-001: Misplaced Code Block
- [ ] Lines 84-90 moved to after line 99 (before the "echo Memory:" line)
- [ ] SWAP recommendation logic tested for all memory ranges:
  - [ ] < 512 MB → 1024 MB recommended
  - [ ] 512-1023 MB → 1536 MB recommended
  - [ ] 1024-2047 MB → 2048 MB recommended
  - [ ] 2048-4095 MB → 3072 MB recommended
  - [ ] 4096-8191 MB → 4096 MB recommended
  - [ ] 8192-16383 MB → 6144 MB recommended
  - [ ] ≥ 16384 MB → 8192 MB recommended
- [ ] SWAP cleanup only executes after user confirms size

### CRITICAL-002: SSH Port Validation Mismatch
- [ ] Documentation (line 48 prompt) matches validation logic
- [ ] Port range consistently documented across script
- [ ] Invalid ports rejected (e.g., 0, 80, 100000)
- [ ] Valid ports accepted (e.g., 2222, 10000, 65535)

### CRITICAL-003: Private SSH Key Exposure
- [ ] Private key NOT logged to file
- [ ] Logging temporarily disabled during key display OR
- [ ] Key never displayed (alternative secure distribution method implemented)
- [ ] Manual test: Check log file doesn't contain "BEGIN OPENSSH PRIVATE KEY"
- [ ] Verified existing log files cleaned or documented for deletion

## High Priority Issues

### HIGH-001: Shell Options
- [ ] `set -euo pipefail` added (or `set -u` + `set -o pipefail` separately)
- [ ] Script tested to ensure `-u` doesn't break existing logic
- [ ] Variables properly initialized before use

### HIGH-002: Password Change Validation
- [ ] `passwd` command return code checked
- [ ] Script exits with error if password change fails
- [ ] Error message displayed to user

### HIGH-003: SSH Restart Verification
- [ ] `systemctl restart sshd` return code checked
- [ ] Service status verified after restart
- [ ] Failure triggers exit with clear error message

### HIGH-004: Infinite Loop Risk
- [ ] Private key confirmation accepts variations: yes, YES, y, Y
- [ ] User can't get trapped in loop
- [ ] Clear instructions for proceeding

### HIGH-005: SWAP Size Bounds
- [ ] Minimum SWAP size enforced (e.g., 128 MB)
- [ ] Maximum SWAP size enforced (e.g., 65536 MB)
- [ ] Available disk space checked before allocation
- [ ] Clear error messages for out-of-bounds values

### HIGH-006: Hostname Validation
- [ ] RFC 1123 hostname validation implemented
- [ ] Special characters rejected
- [ ] Length limit enforced (253 chars max)
- [ ] Empty input handled gracefully

### HIGH-007 & HIGH-008: Code Duplication
- [ ] SWAP cleanup code extracted to function
- [ ] Function called from single location
- [ ] Single backup file created per run (not multiple timestamped files)
- [ ] Backup file management strategy documented

### HIGH-009 & HIGH-010: Download Integrity
- [ ] Docker GPG key fingerprint verified
- [ ] FRP download checksum verified
- [ ] Verification failures halt installation
- [ ] Error messages guide user on resolution

### HIGH-011: FRP Default Credentials
- [ ] Random strong password generated by default
- [ ] Password displayed to user after generation
- [ ] User cannot accidentally accept "admin123"

### HIGH-012: File Locking
- [ ] flock used for /etc/ssh/sshd_config modifications
- [ ] flock used for /etc/fstab modifications
- [ ] flock used for /etc/sysctl.conf modifications
- [ ] Lock acquisition failures handled gracefully

### HIGH-013: Code Readability
- [ ] Multi-line sed command reformatted
- [ ] Each pattern on separate line with comments
- [ ] Or separate sed calls with clear purpose documentation

## Medium Priority Issues

### Error Handling (MEDIUM-001 to MEDIUM-004)
- [ ] Fallocate error check fixed (doesn't rely on `$?` after command that exits)
- [ ] UFW enable success verified
- [ ] Docker GPG key download uses temp file with validation
- [ ] Global error trap implemented for cleanup

### Input Validation (MEDIUM-005 to MEDIUM-007)
- [ ] Timezone offset validated (numeric, -14 to +14 range)
- [ ] FRP ports validated (numeric, 1024-65535 range)
- [ ] Token generation verified (32 chars, non-empty)

### Resource Management (MEDIUM-008 to MEDIUM-010)
- [ ] SSH backup file cleanup strategy documented or implemented
- [ ] Log file descriptor handling verified (tee cleanup)
- [ ] FRP tar.gz cleanup guaranteed even on extraction failure

### Security (MEDIUM-011 to MEDIUM-012)
- [ ] All user inputs validated before use in commands
- [ ] Special characters escaped in sed replacement strings
- [ ] All `read` commands use `-r` flag

### Concurrency (MEDIUM-013 to MEDIUM-015)
- [ ] SSH restart warning added
- [ ] dd/fallocate timeout implemented
- [ ] Network operations have retry logic
- [ ] Network operations have reasonable timeouts

### Code Quality (MEDIUM-016 to MEDIUM-018)
- [ ] Command existence checks standardized
- [ ] Magic numbers replaced with named constants
- [ ] Function documentation added (purpose, params, side effects)

## Low Priority Issues

### LOW-001: Error Silencing
- [ ] Reviewed and documented or improved

### LOW-002: Prompt Defaults
- [ ] Default behavior documented in comments
- [ ] Considered security implications

### LOW-003: Empty Input Handling
- [ ] Whitespace trimmed from all text inputs
- [ ] Empty strings rejected where appropriate

### LOW-004: Hardcoded Paths
- [ ] Considered making configurable (optional)

### LOW-005: sysctl.conf Duplicates
- [ ] Flexible pattern matching or replacement logic

### LOW-006: Root Privileges
- [ ] Considered privilege separation (optional improvement)

### LOW-007: Token Display
- [ ] Sensitive token display reviewed

### LOW-008: API Rate Limiting
- [ ] GitHub API failure handled gracefully
- [ ] Manual version entry option

### LOW-009: Error Message Consistency
- [ ] Standardized error format
- [ ] Consistent severity indicators
- [ ] Actionable guidance included

### LOW-010: Variable Quoting
- [ ] All variable expansions quoted consistently

## Testing Checklist

### Unit Tests
- [ ] Test each function independently where possible
- [ ] Test with valid inputs
- [ ] Test with invalid inputs
- [ ] Test with edge cases (empty, very large, special chars)

### Integration Tests
- [ ] Full run on Debian 11
- [ ] Full run on Debian 12
- [ ] Full run on Ubuntu 20.04
- [ ] Full run on Ubuntu 22.04

### Memory Variations
- [ ] Test on VPS with 512 MB RAM
- [ ] Test on VPS with 1 GB RAM
- [ ] Test on VPS with 2 GB RAM
- [ ] Test on VPS with 4 GB RAM
- [ ] Test on VPS with 8 GB RAM

### Network Conditions
- [ ] Test with fast internet
- [ ] Test with slow internet
- [ ] Test with intermittent connectivity (if possible)
- [ ] Test with GitHub API rate limit exceeded (mock/simulate)

### Error Scenarios
- [ ] Test with wrong password entry (in passwd)
- [ ] Test with invalid hostname entries
- [ ] Test with insufficient disk space
- [ ] Test with SSH restart failure (simulate)
- [ ] Test with Docker download failure (simulate)

### Security Verification
- [ ] Verify private key not in logs
- [ ] Verify strong FRP credentials generated
- [ ] Verify SSH key-only authentication works
- [ ] Verify password auth disabled
- [ ] Verify UFW properly configured
- [ ] Verify Fail2ban monitoring SSH

### Regression Testing
- [ ] All original functionality still works
- [ ] No new issues introduced
- [ ] Summary display accurate
- [ ] Log files complete and parseable

## Sign-Off

- [ ] All CRITICAL issues resolved
- [ ] All HIGH issues resolved
- [ ] MEDIUM issues resolved or documented as acceptable risk
- [ ] LOW issues resolved or documented as future enhancement
- [ ] All tests passing
- [ ] Documentation updated
- [ ] Code reviewed by second person
- [ ] Ready for production use

---

**Notes:**
- Document any deviations from recommendations with justification
- Update this checklist as new issues discovered
- Archive completed checklists with version numbers
